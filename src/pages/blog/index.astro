---
import BaseLayout from '@layouts/BaseLayout.astro';
import BlogCard from '@components/BlogCard.astro';
import FilterTabs from '@components/FilterTabs.astro';
import { getCollection, getEntry } from 'astro:content';
import { type ContentType } from '@data/content-types';

const posts = (await getCollection('blog', ({ data }) => !data.draft))
  .sort((a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf());

// preload author data
const authorMap = new Map<string, { displayName: string; avatar?: string; isAgent: boolean }>();
for (const post of posts) {
  const authorId = post.data.author;
  if (!authorMap.has(authorId)) {
    try {
      const entry = await getEntry('authors', authorId);
      if (entry) authorMap.set(authorId, entry.data);
    } catch {}
  }
}

// count by content type
const counts: Record<'all' | ContentType, number> = { all: posts.length, insight: 0, technical: 0, 'member-essay': 0, meeting: 0 };
for (const p of posts) {
  const t = p.data.contentType as ContentType;
  if (t in counts) counts[t]++;
}
---

<BaseLayout title="Blog · Ray Huang" description="Thoughts on LLM engineering, AI-Native development, and open source.">
  <main class="blog-list">
    <div class="container">
      <div class="page-header">
        <h1 class="page-title">
          <span class="prompt">❯</span>
          <span class="cmd"> ls blog/ --sort=date</span>
        </h1>
        <p class="page-desc">
          Thoughts on LLM engineering, AI-Native development, and open source. ·
          <a href="/blog/tags" class="tags-link">全部标签 →</a>
        </p>
      </div>

      <FilterTabs counts={counts} />

      <ul class="posts" id="posts-list">
        {posts.map(post => (
          <BlogCard
            slug={post.id}
            title={post.data.title}
            description={post.data.description}
            pubDate={post.data.pubDate}
            contentType={post.data.contentType as ContentType}
            tags={post.data.tags}
            authorId={post.data.author}
            authorData={authorMap.get(post.data.author) ?? null}
          />
        ))}
      </ul>

      {posts.length === 0 && (
        <div class="empty">
          <span class="prompt">❯</span>
          <span class="muted"> No posts yet. Check back soon.</span>
        </div>
      )}

      <div class="filter-empty" id="filter-empty" style="display:none">
        <span class="prompt">❯</span>
        <span class="muted"> 该分类暂无文章。</span>
      </div>
    </div>
  </main>
</BaseLayout>

<style>
  .blog-list { padding: var(--space-2xl) var(--space-lg); min-height: calc(100vh - var(--nav-h)); }

  .page-header { margin-bottom: 1.75rem; }
  .page-title {
    font-family: var(--font-mono);
    font-size: 1rem;
    color: var(--color-text-muted);
    margin-bottom: 0.75rem;
  }
  .page-desc { color: var(--color-text-muted); font-size: 0.9rem; }
  .tags-link {
    font-family: var(--font-mono);
    font-size: 0.82rem;
    color: var(--color-text-muted);
    text-decoration: none;
  }
  .tags-link:hover { color: var(--color-accent); }

  .posts { list-style: none; display: flex; flex-direction: column; gap: 1.25rem; }

  .empty, .filter-empty {
    font-family: var(--font-mono);
    font-size: 0.9rem;
    padding: var(--space-xl) 0;
  }
</style>
