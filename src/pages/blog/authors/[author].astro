---
import BaseLayout from '@layouts/BaseLayout.astro';
import { getCollection } from 'astro:content';
import type { CollectionEntry } from 'astro:content';

export async function getStaticPaths() {
  const allAuthors = await getCollection('authors');
  const allPosts = await getCollection('blog', ({ data }) => !data.draft);

  return allAuthors.map((author) => ({
    params: { author: author.id },
    props: {
      author,
      posts: allPosts
        .filter((p) => p.data.author === author.id)
        .sort((a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf()),
    },
  }));
}

interface Props {
  author: CollectionEntry<'authors'>;
  posts: CollectionEntry<'blog'>[];
}

const { author, posts } = Astro.props;
const { displayName, role, bio, philosophy, avatar, isAgent } = author.data;
---

<BaseLayout
  title={`${displayName} ¬∑ ${role} ‚Äî Ray Huang Blog`}
  description={bio}
>
  <main class="author-page">
    <div class="container">

      <div class="page-nav">
        <a href="/blog" class="back">
          <span class="arrow">‚Üê</span> back to blog
        </a>
      </div>

      <header class="author-header">
        <div class="author-avatar">{avatar ?? 'üë§'}</div>
        <div class="author-info">
          <div class="author-name-row">
            <h1 class="author-name">{displayName}</h1>
            {isAgent && <span class="agent-badge">AI Agent</span>}
          </div>
          <p class="author-role">{role}</p>
          <p class="author-bio">{bio}</p>
          <blockquote class="author-philosophy">
            <span class="quote-mark">"</span>{philosophy}<span class="quote-mark">"</span>
          </blockquote>
        </div>
      </header>

      <section class="author-posts">
        <h2 class="section-title">
          <span class="prompt">‚ùØ</span>
          <span class="cmd"> ls blog/ --author={author.id}</span>
          <span class="count">({posts.length} ÁØá)</span>
        </h2>

        {posts.length === 0 ? (
          <div class="empty">
            <span class="muted">ËØ•‰ΩúËÄÖÊöÇÊó†ÂÖ¨ÂºÄÊñáÁ´†„ÄÇ</span>
          </div>
        ) : (
          <ul class="posts">
            {posts.map(post => (
              <li class="post-item">
                <a href={`/blog/${post.id}`} class="post-link">
                  <div class="post-meta">
                    <time datetime={post.data.pubDate.toISOString()}>
                      {post.data.pubDate.toLocaleDateString('zh-CN', { year: 'numeric', month: 'short', day: 'numeric' })}
                    </time>
                  </div>
                  <h3 class="post-title">{post.data.title}</h3>
                  <p class="post-desc">{post.data.description}</p>
                </a>
                <div class="post-tags">
                  {post.data.tags.slice(0, 4).map(tag => (
                    <a href={`/blog/tags/${encodeURIComponent(tag)}`} class="tag">{tag}</a>
                  ))}
                </div>
              </li>
            ))}
          </ul>
        )}
      </section>

    </div>
  </main>
</BaseLayout>

<style>
  .author-page { padding: 3rem 1.5rem; min-height: calc(100vh - 52px); }
  .container { max-width: 780px; margin: 0 auto; }

  .page-nav { margin-bottom: 2rem; }
  .back {
    font-family: var(--font-mono);
    font-size: 0.82rem;
    color: var(--color-text-muted);
    text-decoration: none;
    transition: color 0.2s;
  }
  .back:hover { color: var(--color-accent); }
  .arrow { margin-right: 0.3rem; }

  /* ===== Author Header ===== */
  .author-header {
    display: flex;
    gap: 1.5rem;
    align-items: flex-start;
    padding: 1.75rem;
    background: var(--color-bg-2);
    border: 1px solid var(--color-border);
    border-radius: 10px;
    margin-bottom: 2.5rem;
  }

  .author-avatar {
    font-size: 3rem;
    line-height: 1;
    flex-shrink: 0;
    width: 3.5rem;
    text-align: center;
  }

  .author-info { flex: 1; min-width: 0; }

  .author-name-row {
    display: flex;
    align-items: center;
    gap: 0.6rem;
    margin-bottom: 0.25rem;
    flex-wrap: wrap;
  }

  .author-name {
    font-size: 1.4rem;
    font-weight: 700;
    color: var(--color-text);
    margin: 0;
  }

  .agent-badge {
    font-family: var(--font-mono);
    font-size: 0.65rem;
    padding: 0.1rem 0.5rem;
    border: 1px solid var(--color-accent);
    border-radius: 20px;
    color: var(--color-accent);
    background: rgba(88, 166, 255, 0.08);
    letter-spacing: 0.05em;
    text-transform: uppercase;
  }

  .author-role {
    font-family: var(--font-mono);
    font-size: 0.78rem;
    color: var(--color-accent);
    margin: 0 0 0.6rem;
  }

  .author-bio {
    font-size: 0.9rem;
    color: var(--color-text-muted);
    line-height: 1.6;
    margin: 0 0 0.75rem;
  }

  .author-philosophy {
    border-left: 3px solid var(--color-accent);
    padding: 0.45rem 0.85rem;
    margin: 0;
    background: rgba(88, 166, 255, 0.05);
    border-radius: 0 5px 5px 0;
    font-size: 0.85rem;
    color: var(--color-text-muted);
    font-style: italic;
    line-height: 1.5;
  }

  .quote-mark {
    color: var(--color-accent);
    font-style: normal;
    font-size: 1rem;
    opacity: 0.6;
  }

  /* ===== Posts Section ===== */
  .section-title {
    font-family: var(--font-mono);
    font-size: 0.9rem;
    color: var(--color-text-muted);
    margin-bottom: 1.25rem;
    font-weight: 400;
  }
  .section-title .prompt { color: var(--color-green); margin-right: 0.3rem; }
  .section-title .count { color: var(--color-accent); margin-left: 0.5rem; }

  .posts { list-style: none; display: flex; flex-direction: column; gap: 1.25rem; }

  .post-item {
    background: var(--color-bg-2);
    border: 1px solid var(--color-border);
    border-radius: 8px;
    overflow: hidden;
    transition: border-color 0.2s, transform 0.2s;
  }
  .post-item:hover { border-color: var(--color-accent); transform: translateY(-1px); }

  .post-link {
    display: block;
    padding: 1.25rem 1.5rem 0.75rem;
    color: inherit;
    text-decoration: none;
  }

  .post-meta { margin-bottom: 0.5rem; }
  time {
    font-family: var(--font-mono);
    font-size: 0.78rem;
    color: var(--color-text-muted);
  }

  .post-title {
    font-size: 1.05rem;
    font-weight: 600;
    color: var(--color-text);
    margin: 0 0 0.4rem;
    line-height: 1.4;
    transition: color 0.2s;
  }
  .post-link:hover .post-title { color: var(--color-accent); }

  .post-desc { font-size: 0.85rem; color: var(--color-text-muted); line-height: 1.6; margin: 0; }

  .post-tags {
    display: flex;
    gap: 0.3rem;
    flex-wrap: wrap;
    padding: 0.6rem 1.5rem;
    border-top: 1px solid var(--color-border);
  }

  .tag {
    font-family: var(--font-mono);
    font-size: 0.68rem;
    background: var(--color-bg-3);
    border: 1px solid var(--color-border);
    border-radius: 4px;
    padding: 0.1rem 0.45rem;
    color: var(--color-text-muted);
    text-decoration: none;
    transition: color 0.15s, border-color 0.15s;
  }
  .tag:hover { color: var(--color-accent); border-color: var(--color-accent); }

  .empty { font-family: var(--font-mono); font-size: 0.88rem; padding: 2rem 0; }
  .empty .muted { color: var(--color-text-muted); }

  @media (max-width: 540px) {
    .author-header { flex-direction: column; gap: 1rem; }
    .author-avatar { font-size: 2.5rem; }
  }
</style>
