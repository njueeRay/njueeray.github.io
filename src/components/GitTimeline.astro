---
// GitTimeline — Git Graph 风格垂直时间线组件
// 数据驱动，支持分支可视化和滚动渐显动画
import { events, typeConfig, type TimelineEvent } from '../data/team-evolution';

// 预处理：识别分支组
const branchGroups = new Map<number, TimelineEvent[]>();
events.forEach(e => {
  if (e.branchGroup !== undefined) {
    if (!branchGroups.has(e.branchGroup)) branchGroups.set(e.branchGroup, []);
    branchGroups.get(e.branchGroup)!.push(e);
  }
});
---

<section class="git-timeline" id="timeline">
  <div class="timeline-track">

    {events.map((event) => {
      const cfg = typeConfig[event.type];
      const isBranch = !!event.branch;
      // 判断是否是分支组的第一个事件（需要显示 fork 标签）
      const isFirstInGroup = event.branchGroup !== undefined &&
        branchGroups.get(event.branchGroup)?.[0] === event;
      // 判断是否是分支组的最后一个事件（需要显示 merge 标签）
      const isLastInGroup = event.branchGroup !== undefined &&
        branchGroups.get(event.branchGroup)?.at(-1) === event;
      const isOnlyBranch = event.branch && !event.branchGroup;

      return (
        <>
          {/* 分支组开始标记 */}
          {isFirstInGroup && (
            <div class="branch-fork">
              <span class="branch-icon">⑂</span>
              <span class="branch-text">parallel branches</span>
            </div>
          )}

          {/* 独立分支开始标记 */}
          {isOnlyBranch && (
            <div class="branch-fork">
              <span class="branch-icon">⑂</span>
              <span class="branch-text">branch</span>
            </div>
          )}

          <div
            class:list={[
              'tl-event',
              `type-${event.type}`,
              isBranch && 'is-branch',
            ]}
            style={`--node-color: ${cfg.color};`}
            data-animate
          >
            {/* 节点 */}
            <div class="tl-node">
              <div class="dot"></div>
              {event.version && (
                <span class="version-tag" style={`--tag-color: ${cfg.color};`}>
                  {event.version}
                </span>
              )}
            </div>

            {/* 内容卡片 */}
            <div class="tl-card">
              <div class="card-head">
                <time datetime={event.date}>{event.date}</time>
                <span class="type-badge" style={`color: ${cfg.color};`}>
                  {cfg.icon} {cfg.label}
                </span>
              </div>

              {isBranch && (
                <div class="branch-chip">
                  <svg width="12" height="12" viewBox="0 0 16 16" fill="currentColor"><path d="M9.5 3.25a2.25 2.25 0 1 1 3 2.122V6A2.5 2.5 0 0 1 10 8.5H6a1 1 0 0 0-1 1v1.128a2.251 2.251 0 1 1-1.5 0V5.372a2.25 2.25 0 1 1 1.5 0v1.836A2.492 2.492 0 0 1 6 7h4a1 1 0 0 0 1-1v-.628A2.25 2.25 0 0 1 9.5 3.25z"/></svg>
                  {event.branch}
                </div>
              )}

              <h3 class="card-title">{event.title}</h3>
              <p class="card-desc">{event.description}</p>

              {event.agents.length > 0 && (
                <div class="card-agents">
                  {event.agents.map(a => (
                    <span class="agent-chip" title={a.name}>
                      <span class="agent-emoji">{a.emoji}</span>
                      <span class="agent-name">{a.name}</span>
                    </span>
                  ))}
                </div>
              )}
            </div>
          </div>

          {/* 分支组结束标记 */}
          {(isLastInGroup || (isOnlyBranch)) && (
            <div class="branch-merge">
              <span class="branch-icon">⑃</span>
              <span class="branch-text">merged to main</span>
            </div>
          )}
        </>
      );
    })}

    {/* 终点标记 */}
    <div class="tl-end" data-animate>
      <div class="tl-node">
        <div class="dot end-dot">▼</div>
      </div>
      <div class="tl-card end-card">
        <span class="end-label">NOW — 下一个里程碑等你书写</span>
      </div>
    </div>
  </div>
</section>

<style>
  /* ─── Timeline Container ─── */
  .git-timeline {
    position: relative;
    max-width: 740px;
    margin: 0 auto;
    padding: 0 1rem;
  }

  .timeline-track {
    position: relative;
    padding-left: 32px;
  }

  /* ─── 主干线（Trunk Line） ─── */
  .timeline-track::before {
    content: '';
    position: absolute;
    left: 9px;
    top: 8px;
    bottom: 40px;
    width: 3px;
    background: var(--color-accent);
    box-shadow: 0 0 12px rgba(88, 166, 255, 0.3);
    border-radius: 4px;
  }

  /* ─── 事件行 ─── */
  .tl-event {
    position: relative;
    display: flex;
    gap: 1.2rem;
    padding-bottom: 1.8rem;
    opacity: 0;
    transform: translateY(16px);
    transition: opacity 0.5s ease, transform 0.5s ease;
  }

  .tl-event.visible {
    opacity: 1;
    transform: translateY(0);
  }

  /* ─── 节点（Node） ─── */
  .tl-node {
    position: relative;
    flex-shrink: 0;
    width: 0;
    display: flex;
    align-items: flex-start;
    padding-top: 0.6rem;
  }

  .dot {
    position: absolute;
    left: -38px;
    width: 14px;
    height: 14px;
    border-radius: 50%;
    background: var(--color-bg);
    border: 3px solid var(--node-color);
    box-shadow:
      0 0 0 3px var(--color-bg),
      0 0 12px var(--node-color);
    z-index: 2;
    transition: box-shadow 0.3s ease, transform 0.3s ease;
  }

  .tl-event:hover .dot {
    box-shadow:
      0 0 0 3px var(--color-bg),
      0 0 20px var(--node-color),
      0 0 40px rgba(88, 166, 255, 0.15);
    transform: scale(1.15);
  }

  /* 连接线（Node → Card） */
  .tl-event::before {
    content: '';
    position: absolute;
    left: -1px;
    top: calc(0.6rem + 5px);
    width: 28px;
    height: 2px;
    background: linear-gradient(to right, var(--node-color), transparent);
    opacity: 0.4;
  }

  /* 版本标签 */
  .version-tag {
    position: absolute;
    left: -90px;
    top: -2px;
    font-family: var(--font-mono);
    font-size: 0.65rem;
    font-weight: 700;
    color: var(--tag-color);
    background: rgba(88, 166, 255, 0.08);
    border: 1px solid var(--tag-color);
    border-radius: 4px;
    padding: 1px 6px;
    white-space: nowrap;
    opacity: 0.85;
  }

  /* ─── 分支事件缩进 ─── */
  .tl-event.is-branch {
    padding-left: 18px;
  }

  .tl-event.is-branch::before {
    width: 46px;
  }

  .tl-event.is-branch .dot {
    left: -20px;
  }

  /* ─── 内容卡片 ─── */
  .tl-card {
    flex: 1;
    background: var(--color-bg-2);
    border: 1px solid var(--color-border);
    border-left: 3px solid var(--node-color);
    border-radius: 8px;
    padding: 0.85rem 1.1rem;
    transition: border-color 0.3s ease, box-shadow 0.3s ease;
  }

  .tl-event:hover .tl-card {
    border-color: var(--node-color);
    box-shadow: 0 0 20px rgba(88, 166, 255, 0.06);
  }

  .card-head {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 0.4rem;
  }

  .card-head time {
    font-family: var(--font-mono);
    font-size: 0.72rem;
    color: var(--color-text-muted);
  }

  .type-badge {
    font-family: var(--font-mono);
    font-size: 0.68rem;
    font-weight: 600;
  }

  /* 分支标签 */
  .branch-chip {
    display: inline-flex;
    align-items: center;
    gap: 4px;
    font-family: var(--font-mono);
    font-size: 0.68rem;
    color: var(--color-text-muted);
    background: rgba(247, 120, 186, 0.08);
    border: 1px solid rgba(247, 120, 186, 0.25);
    border-radius: 4px;
    padding: 1px 8px;
    margin-bottom: 0.4rem;
  }

  .branch-chip svg {
    opacity: 0.7;
  }

  .card-title {
    font-family: var(--font-mono);
    font-size: 0.92rem;
    font-weight: 700;
    color: var(--color-text);
    margin: 0 0 0.3rem;
    line-height: 1.4;
  }

  .card-desc {
    font-size: 0.82rem;
    color: var(--color-text-muted);
    line-height: 1.55;
    margin: 0 0 0.5rem;
  }

  /* Agent chips */
  .card-agents {
    display: flex;
    flex-wrap: wrap;
    gap: 0.35rem;
  }

  .agent-chip {
    display: inline-flex;
    align-items: center;
    gap: 3px;
    font-family: var(--font-mono);
    font-size: 0.7rem;
    color: var(--color-text-muted);
    background: var(--color-bg-3);
    border-radius: 12px;
    padding: 2px 8px 2px 4px;
    transition: background 0.2s;
  }

  .agent-chip:hover {
    background: var(--color-border);
  }

  .agent-emoji {
    font-size: 0.82rem;
  }

  /* ─── 分支指示器 ─── */
  .branch-fork,
  .branch-merge {
    position: relative;
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.5rem 0 0.5rem 0;
    font-family: var(--font-mono);
    font-size: 0.72rem;
    color: var(--color-text-muted);
    opacity: 0;
    transform: translateY(8px);
    transition: opacity 0.4s ease, transform 0.4s ease;
  }

  .branch-fork.visible,
  .branch-merge.visible {
    opacity: 1;
    transform: translateY(0);
  }

  .branch-icon {
    font-size: 1rem;
    color: #f778ba;
  }

  .branch-text {
    opacity: 0.7;
  }

  /* 分支 fork 连接线 */
  .branch-fork::before {
    content: '';
    position: absolute;
    left: -23px;
    top: 50%;
    width: 20px;
    height: 2px;
    background: #f778ba;
    opacity: 0.4;
  }

  /* 分支 merge 连接线 */
  .branch-merge::before {
    content: '';
    position: absolute;
    left: -23px;
    top: 50%;
    width: 20px;
    height: 2px;
    background: #3fb950;
    opacity: 0.4;
  }

  .branch-merge .branch-icon {
    color: #3fb950;
  }

  /* ─── 终点标记 ─── */
  .tl-end {
    position: relative;
    display: flex;
    gap: 1.2rem;
    padding-top: 0.5rem;
    opacity: 0;
    transform: translateY(16px);
    transition: opacity 0.5s ease, transform 0.5s ease;
  }

  .tl-end.visible {
    opacity: 1;
    transform: translateY(0);
  }

  .end-dot {
    position: absolute;
    left: -42px;
    width: 22px;
    height: 22px;
    border-radius: 50%;
    background: var(--color-bg);
    border: 3px solid var(--color-accent);
    box-shadow: 0 0 16px rgba(88, 166, 255, 0.4);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.6rem;
    color: var(--color-accent);
    z-index: 2;
    animation: pulse-glow 2s ease-in-out infinite;
  }

  @keyframes pulse-glow {
    0%, 100% { box-shadow: 0 0 16px rgba(88, 166, 255, 0.4); }
    50% { box-shadow: 0 0 28px rgba(88, 166, 255, 0.7); }
  }

  .end-card {
    border: none;
    background: none;
    padding: 0.3rem 0;
  }

  .end-label {
    font-family: var(--font-mono);
    font-size: 0.78rem;
    color: var(--color-text-muted);
    font-style: italic;
  }

  /* ─── 响应式 ─── */
  @media (max-width: 600px) {
    .timeline-track {
      padding-left: 24px;
    }

    .version-tag {
      position: static;
      display: inline-block;
      margin-bottom: 0.3rem;
    }

    .tl-event.is-branch {
      padding-left: 8px;
    }

    .card-head {
      flex-direction: column;
      align-items: flex-start;
      gap: 0.2rem;
    }

    .tl-card {
      padding: 0.7rem 0.85rem;
    }
  }
</style>

<script>
  // 滚动渐显动画
  function initTimelineAnimations() {
    const elements = document.querySelectorAll('[data-animate], .branch-fork, .branch-merge');

    const observer = new IntersectionObserver(
      (entries) => {
        entries.forEach((entry) => {
          if (entry.isIntersecting) {
            // 延迟递增，让事件依次出现
            const index = Array.from(elements).indexOf(entry.target as Element);
            const delay = Math.min(index * 60, 400);
            setTimeout(() => {
              entry.target.classList.add('visible');
            }, delay);
            observer.unobserve(entry.target);
          }
        });
      },
      { threshold: 0.15, rootMargin: '0px 0px -40px 0px' }
    );

    elements.forEach((el) => observer.observe(el));
  }

  // 支持 ViewTransitions
  document.addEventListener('astro:page-load', initTimelineAnimations);
</script>
