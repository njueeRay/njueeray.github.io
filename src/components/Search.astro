---
// Search: Pagefind inline search modal — triggered by nav button or Ctrl+K
---

<div id="search-overlay" class="search-overlay" data-visible="false">
  <div class="search-modal">
    <div class="search-header">
      <span class="search-icon">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
      </span>
      <input id="search-input" type="text" placeholder="搜索文章..." autocomplete="off" />
      <kbd class="search-kbd">ESC</kbd>
    </div>
    <div id="search-results" class="search-results"></div>
  </div>
</div>

<script is:inline>
  // Pagefind search integration
  (function() {
    function initPagefind() {
      var overlay = document.getElementById('search-overlay');
      var input = document.getElementById('search-input');
      var results = document.getElementById('search-results');
      if (!overlay || !input || !results) return;

      var pagefind = null;

      function loadPagefind() {
        if (pagefind) return;
        import('/pagefind/pagefind.js').then(function(pf) {
          pagefind = pf;
          pagefind.init();
        }).catch(function() {
          results.innerHTML = '<div class="search-empty">搜索索引未找到，请先执行构建。</div>';
        });
      }

      function openSearch() {
        overlay.setAttribute('data-visible', 'true');
        document.body.style.overflow = 'hidden';
        input.value = '';
        results.innerHTML = '<div class="search-empty">输入关键词开始搜索</div>';
        setTimeout(function() { input.focus(); }, 50);
        loadPagefind();
      }

      function closeSearch() {
        overlay.setAttribute('data-visible', 'false');
        document.body.style.overflow = '';
        input.value = '';
        results.innerHTML = '';
      }

      // Search button
      document.querySelectorAll('[data-search-trigger]').forEach(function(btn) {
        btn.addEventListener('click', openSearch);
      });

      // Ctrl+K / Cmd+K
      document.addEventListener('keydown', function(e) {
        if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
          e.preventDefault();
          openSearch();
        }
        if (e.key === 'Escape') closeSearch();
      });

      // Close on backdrop click
      overlay.addEventListener('click', function(e) {
        if (e.target === overlay) closeSearch();
      });

      // Search with debounce
      var debounceTimer;
      input.addEventListener('input', function() {
        clearTimeout(debounceTimer);
        debounceTimer = setTimeout(function() {
          var query = input.value.trim();
          if (!query) {
            results.innerHTML = '<div class="search-empty">输入关键词开始搜索</div>';
            return;
          }
          if (!pagefind) {
            results.innerHTML = '<div class="search-empty">正在加载搜索索引...</div>';
            return;
          }
          pagefind.search(query).then(function(search) {
            if (search.results.length === 0) {
              results.innerHTML = '<div class="search-empty">没有找到匹配结果</div>';
              return;
            }
            Promise.all(search.results.slice(0, 8).map(function(r) { return r.data(); })).then(function(items) {
              results.innerHTML = items.map(function(item) {
                return '<a href="' + item.url + '" class="search-result-item">' +
                  '<div class="search-result-title">' + (item.meta && item.meta.title ? item.meta.title : item.url) + '</div>' +
                  '<div class="search-result-excerpt">' + (item.excerpt || '') + '</div>' +
                  '</a>';
              }).join('');
            });
          });
        }, 200);
      });
    }

    // Init on page load + View Transitions
    initPagefind();
    document.addEventListener('astro:after-swap', initPagefind);
  })();
</script>

<style>
  .search-overlay {
    position: fixed;
    inset: 0;
    z-index: 9999;
    background: rgba(0, 0, 0, 0.6);
    backdrop-filter: blur(4px);
    display: flex;
    align-items: flex-start;
    justify-content: center;
    padding-top: 15vh;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.15s;
  }
  .search-overlay[data-visible="true"] {
    opacity: 1;
    pointer-events: auto;
  }

  .search-modal {
    width: 90%;
    max-width: 560px;
    background: var(--color-bg-2);
    border: 1px solid var(--color-border);
    border-radius: 12px;
    overflow: hidden;
    box-shadow: 0 16px 48px rgba(0, 0, 0, 0.4);
    transform: scale(0.96);
    transition: transform 0.15s;
  }
  .search-overlay[data-visible="true"] .search-modal {
    transform: scale(1);
  }

  .search-header {
    display: flex;
    align-items: center;
    gap: 0.6rem;
    padding: 0.75rem 1rem;
    border-bottom: 1px solid var(--color-border);
  }

  .search-icon { color: var(--color-text-muted); display: flex; }

  #search-input {
    flex: 1;
    background: none;
    border: none;
    outline: none;
    color: var(--color-text);
    font-family: var(--font-mono);
    font-size: 0.88rem;
  }
  #search-input::placeholder { color: var(--color-text-muted); }

  .search-kbd {
    font-family: var(--font-mono);
    font-size: 0.65rem;
    padding: 0.15rem 0.4rem;
    background: var(--color-bg-3);
    border: 1px solid var(--color-border);
    border-radius: 3px;
    color: var(--color-text-muted);
  }

  .search-results {
    max-height: 400px;
    overflow-y: auto;
    padding: 0.5rem;
  }

  .search-empty {
    padding: 1.5rem;
    text-align: center;
    color: var(--color-text-muted);
    font-family: var(--font-mono);
    font-size: 0.82rem;
  }

  .search-result-item {
    display: block;
    padding: 0.6rem 0.8rem;
    border-radius: 6px;
    text-decoration: none;
    transition: background 0.15s;
  }
  .search-result-item:hover {
    background: rgba(88, 166, 255, 0.08);
  }

  .search-result-title {
    color: var(--color-text);
    font-size: 0.88rem;
    font-weight: 500;
    margin-bottom: 0.2rem;
  }

  .search-result-excerpt {
    color: var(--color-text-muted);
    font-size: 0.78rem;
    line-height: 1.4;
    overflow: hidden;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
  }
  .search-result-excerpt :global(mark) {
    background: rgba(88, 166, 255, 0.25);
    color: var(--color-accent);
  }
</style>
